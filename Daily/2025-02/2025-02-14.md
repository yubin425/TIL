## ë‚ ì§œ: 2025-02-14

### ìŠ¤í¬ëŸ¼
- yaml íŒŒì¼ êµ¬ì¡° ê³µë¶€
- DCT í™œì„±í™” ì´ë¯¸ì§€ ë§Œë“¤ê¸°

#### Docker ì´ë¯¸ì§€ ì„œëª… ë° ë¬´ê²°ì„± ê²€ì¦ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

â€¢ Docker Content Trust (DCT) í™œì„±í™” ë° ì„œëª…ëœ ì´ë¯¸ì§€ í‘¸ì‹œ
â€¢ ì„œëª…ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œë„ ë° ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸

```bash
#ì´ë ‡ê²Œ í•˜ë©´ ëœë‹¤ë˜ë°
export DOCKER_CONTENT_TRUST=1

#ì•ˆëœë‹¤...
docker push 172.19.0.1:5000/go_helloworld2:latest
The push refers to repository [172.19.0.1:5000/go_helloworld2]
419e3d815682: Layer already exists
5f70bf18a086: Layer already exists
89b59b1b7cb3: Layer already exists
latest: digest: sha256:94f69cb1ca03d24aaa21ff5c07cc66fe7cf34dbac00b54ea8c22d4cf37ded1b5 size: 945
Signing and pushing trust metadata
Error: error contacting notary server: tls: failed to verify certificate: x509: certificate relies on legacy Common Name field, use SANs instead
```

ğŸ¤”Â ì„œëª…ëœ ì´ë¯¸ì§€ê°€ ì•„ë‹Œê°€?Â ì™œ ì•ˆë˜ëŠ”ê±°ì§€? ì—ëŸ¬ë¥¼ ë¶„ì„í•´ë³´ì. 

`Error: error contacting notary server: tls: failed to verify certificate: x509: certificate relies on legacy Common Name field, use SANs instead`

notary ì„œë²„ì™€ì˜ ì—°ê²°ì—ì„œ ë°œìƒí•œ ë¬¸ì œë¡œ, ì¦ì„œì— ì‚¬ìš©ëœ `Common Name`(CN) í•„ë“œê°€ ë” ì´ìƒ ê¶Œì¥ë˜ì§€ ì•Šê³  `Subject Alternative Names`(SANs)ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ê³  í•œë‹¤. 

ê²°êµ­ì—ëŠ” ì¸ì¦ì„œ ë¬¸ì œì¸ê±°ë¼ `docker`ì˜ `certs` ë””ë ‰í† ë¦¬ì— ì¸ì¦ì„œë¥¼ ì¶”ê°€í•¨ìœ¼ë¡œì¨ í•´ê²°ì´ ë  ìˆ˜ë„ ìˆë‹¤ê³  í•œë‹¤. 

â†’ ì¸ì¦ì„œ í´ë”ë¥¼ í™•ì¸í•´ë³´ë‹ˆ ca.crtëŠ” ì¶”ê°€ê°€ ë˜ì–´ ìˆëŠ”ë°, server.crtëŠ” ì¶”ê°€ê°€ ì•ˆë˜ì–´ ìˆì—ˆë‹¤. 

```bash
#ë‹¤ì‹œ ì˜®ê²¨ë³´ì

#ë§Œë“¤ì–´ë‘” server.crtë¥¼ ë³µë¶™í•œë‹¤. ì´ ì¸ì¦ì„œëŠ” ë‹¨ê³„2ì—ì„œ ë§Œë“¤ì–´ë’€ë˜ ì¸ì¦ì„œë‹¤.
nilla@nilla:~/docker-registry/certs$ ls
extfile.cnf  server.crt  server.csr  server.key  sudo
nilla@nilla:~/docker-registry/certs$ sudo cp server.crt /etc/docker/certs.d/172.19.0.1:5000/

```

â†’ ì¶”ê°€í–ˆì§€ë§Œ ì—¬ì „íˆ ê°™ì€ ì˜¤ë¥˜ ë°œìƒ. ê·¼ë° ìƒê°í•´ë³´ë‹ˆ ì´ë¯¸ì§€ ì„œëª… ì„¤ì • ê°™ì€ ê±´ ë”°ë¡œ í•œ ì ì´ ì—†ëŠ” ê²ƒ ê°™ë‹¤.

`docker trust sign 172.19.0.1:5000/go_helloworld2:latest` ì„ ì‚¬ìš©í•˜ë©´ ì„œëª…í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤!

```bash
#ë˜ ë˜‘ê°™ì€ ì˜¤ë¥˜ì™€ ë§ˆì£¼ì³¤ë‹¤. 
docker trust sign 172.19.0.1:5000/go_helloworld2:latest
Error: error contacting notary server: tls: failed to verify certificate: x509: certificate relies on legacy Common Name field, use SANs instead
```

ì°¾ì•„ë³´ë‹ˆ sanìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ë§Œë“œëŠ” ë°©ë²•ì´ ìˆë‹¤ê³  í•œë‹¤! https://ikcoo.tistory.com/143

```bash
sudo nano /etc/ssl/openssl.cnf #< ì´ íŒŒì¼ì„ ì—´ì–´ì„œ ìˆ˜ì •í•˜ì

[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[ alt_names ]
IP.1 = ì„œë²„ì˜ IP ì£¼ì†Œ

#CSR ìƒì„±
openssl req -new -newkey rsa:2048 -nodes -keyout server.key -out server.csr -config /etc/ssl/openssl.cnf
#ì¸ì¦ì„œ ì¬ë°œê¸‰
openssl x509 -req -in server.csr -signkey server.key -out server.crt -days 365 -extensions v3_req -extfile /etc/ssl/openssl.cnf

openssl x509 -in server.crt -noout -text
#ì´ ë°‘ì— ìˆëŠ” í•­ëª©ì´ sanì´ ë“±ë¡ëœ í•­ëª©ì´ë¼ê³  í•œë‹¤.
 X509v3 Subject Alternative Name: 
 IP Address:172.19.0.1

```

â†’ ê·¸ëŸ¬ë‚˜ ì—¬ì „íˆ ìœ„ì™€ ê°™ì€ ë¬¸ì œê°€ ë°œìƒ

#### GitLab & GitLab Runnerë¥¼ í™œìš©í•œ CI/CD êµ¬ì¶•
1. **.gitlab-ci.ymlì˜ êµ¬ì¡°**
    
    ```yaml
    #stages: ìˆ˜í–‰í•  ì‘ì—…ì˜ ì‹œê¸°ë¥¼ ì •ì˜í•¨. ì‘ì„±í•œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ëœë‹¤. 
    stages: 
    	- build
    	- test
    	- deploy
    
    #job: ìˆ˜í–‰í•  ì‘ì—…ì„ ëœ»í•¨. 
    deploy: #ì´ê²Œ jobì´ë¦„
      image: docker:latest
      # ì´ê±´ jobì˜ stage ì„¤ì •
      stage: deploy
      
    #branch: ì„ íƒí•œ branchê°€ mergeë ë•Œ í•´ë‹¹ jobì´ ì‹¤í–‰ëœë‹¤. 
    only:
        - main  # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
        
    #runner ì„ íƒ
    #íƒœê·¸ë¡œ ëŸ¬ë„ˆë¥¼ ì„ íƒí•œë‹¤. ì„ íƒëœ ëŸ¬ë„ˆê°€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê²Œ ëœë‹¤.
    #ì—¬ëŸ¬ê°œì˜ íƒœê·¸ë¥¼ ì§€ì •í•˜ë©´ íƒœê·¸ë¥¼ ëª¨ë‘ ê°€ì§€ê³  ìˆëŠ” runnerê°€ ì„ íƒëœë‹¤.
    tags: 
    	- aws
    	- live
    	- logistics-jpc
    	
    #variables: jobì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜
    variables:
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: ""
      DOCKER_HOST: "tcp://docker:2375"  # Docker í˜¸ìŠ¤íŠ¸ ì„¤ì •
      IMAGE_NAME: "$CI_PROJECT_NAME"   # ì´ë¯¸ì§€ ì´ë¦„ì€ CI_PROJECT_NAME í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      DOCKER_HUB_USER: "user"     # Docker Hub ì‚¬ìš©ì ì´ë¦„
      DOCKER_HUB_PASSWORD: "$DOCKER_HUB_PASSWORD"  # Docker Hub ë¹„ë°€ë²ˆí˜¸ (CI/CD ë³€ìˆ˜ë¡œ ì„¤ì •)
      
    #script: runnerê°€ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
    script:
        - sleep 20  # Docker ë°ëª¬ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        - docker info  # Docker ë°ëª¬ ì •ë³´ í™•ì¸
        - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_PASSWORD"  # Docker Hub ë¡œê·¸ì¸
        - docker build -t "$DOCKER_HUB_USER/$IMAGE_NAME:latest" .  # Docker ì´ë¯¸ì§€ ë¹Œë“œ
        - docker push "$DOCKER_HUB_USER/$IMAGE_NAME:latest"  # Docker Hubì— í‘¸ì‹œ
        - docker run -d --name "$IMAGE_NAME" -p 8080:80 "$DOCKER_HUB_USER/$IMAGE_NAME:latest"  # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    ```
    

2. ë§ˆì¸í¬ë˜í”„íŠ¸ë¥¼ yml íŒŒì¼ë¡œ ëŒë ¤ë³´ì
- ì‚¬ì‹¤ ì ì ˆí•œ ë°©ë²•ì€ ì•„ë‹ˆë‹¤. ë§ˆí¬ ì†ŒìŠ¤ì½”ë“œë¥¼ ì˜¬ë¦¬ëŠ” ê±´ ì•„ë‹ˆê³ , ê·¸ëƒ¥ awesome composeì˜ ë§ˆí¬ íŒŒì¼ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸
- ê·¸ë˜ë„ ì œê³µëœ docker-compose íŒŒì¼ì„ ìë™í™”ë¡œ ë¹Œë“œí•´ì„œ ë°°í¬í•´ì£¼ëŠ”ê±¸ ëª©í‘œë¡œ yml íŒŒì¼ì„ ì‘ì„±í•´ë³´ì.

docker-compose íŒŒì¼ì€ awesome composeê°€ ë°°í¬í•´ì¤€ ê²ƒì„ ì‚¬ìš©í–ˆë‹¤. https://github.com/docker/awesome-compose/blob/master/minecraft/compose.yaml

```yaml
services:
 minecraft:
   image: itzg/minecraft-server
   ports:
     - "25565:25565"
   environment:
     EULA: "TRUE"
   deploy:
     resources:
       limits:
         memory: 1.5G
   volumes:
     - "~/minecraft_data:/data"
```

ì²«ë²ˆì§¸ ì‹œë„

**.gitlab-ci.ymlì„ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆë‹¤.**

```yaml
#gitlab-ci.yml
image: docker:latest

# Docker-in-Docker (dind) ì„œë¹„ìŠ¤ ì‚¬ìš©
services:
  - name: docker:dind
    alias: docker

stages: 
  - deploy

deploy: 
  stage: deploy
  script: 
    - docker-compose -f docker-compose.yml up -d 

```

ğŸ¤”Â  Docker-in-Docker (dind) ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ? : 

GitLab CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ **Docker ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰**í•˜ë ¤ë©´ **Docker Daemon**ì´ í•„ìš”í•˜ë‹¤. í•˜ì§€ë§Œ GitLab RunnerëŠ” ê° íŒŒì´í”„ë¼ì¸ì„ **ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰**í•˜ë¯€ë¡œ, ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ Dockerë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ **Docker-in-Docker**(DinD) ë°©ì‹ì´ í•„ìš”í•˜ë‹¤. ì´ë¥¼ í†µí•´ **Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê±°ë‚˜, ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

<img src="img/61.png">


ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. ì˜¤ë¥˜ë¥¼ ì‚´í´ë³´ì. 

```yaml
$ docker-compose -f docker-compose.yml up -d
unable to get image 'itzg/minecraft-server': error during connect: Get "http://docker:2375/v1.47/images/itzg/minecraft-server/json": dial tcp: lookup docker on 1.214.68.2:53: no such host
Cleaning up project directory and file based variables
00:00
ERROR: Job failed: exit code 1
```

ë„ì»¤ë¼ëŠ” í˜¸ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤ëŠ” ëœ»ì´ë¼ê³  í•œë‹¤. docker hostëŠ” ë­ì§€?

â†’ ë„ì»¤ê°€ ë„ìš´ ì»¨í…Œì´ë„ˆë“¤ì„ ê´€ë¦¬í•˜ëŠ” ê³³ì„ docker hostë¼ê³  í•œë‹¤. 

`export DOCKER_HOST=tcp://docker:2375` ë¥¼ í†µí•´ docker hostë¥¼ tcp í†µì‹ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì–´ì•¼ í•œë‹¤. ì›ë˜ docker daemonì€ ë¡œì»¬ ì†Œì¼“ì„ ì‚¬ìš©í•´ í´ë¼ì´ì–¸íŠ¸ì™€ ì†Œí†µí•˜ëŠ”ë°, ì´ ê²½ìš°ì—” ì»¨í…Œì´ë„ˆ ì•ˆì— ìˆìœ¼ë¯€ë¡œ tcp ì†Œì¼“ í†µì‹ ì´ í•„ìš”í•˜ë‹¤. 

â†’ ê·¸ëŸ¬ë‚˜ ì‹¤íŒ¨

1. ë‘ë²ˆì§¸ ì‹œë„

docker exec -it f12eca0dcee8 cat /etc/gitlab-runner/config.toml ê°€ ë¬¸ì œì˜€ë‹¤.

```yaml
[runners.docker]
  image = "docker:latest"
  privileged = true
  tls_verify = false
  disable_entrypoint_overwrite = false
  oom_kill_disable = false
  disable_cache = false
  volumes = ["/cache"]
  tls_verify = false  # <- ì´ ë¶€ë¶„ì€ ì¤‘ë³µì…ë‹ˆë‹¤.
```

`privileged = true` ë¡œ ë°”ê¿”ì•¼ í•œë‹¤.

**Privileged ëª¨ë“œ**ëŠ” ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì¼ë°˜ ì»¨í…Œì´ë„ˆë³´ë‹¤ ë” ë†’ì€ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ëª¨ë“œë¥¼ ë§í•œë‹¤.

- **ê¸°ë³¸ ì»¨í…Œì´ë„ˆì™€ì˜ ì°¨ì´ì :**
    
    ì¼ë°˜ ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œê³¼ ê²©ë¦¬ë˜ì–´ ì œí•œëœ ê¶Œí•œë§Œ ê°€ì§€ì§€ë§Œ, privileged ëª¨ë“œì—ì„œëŠ” ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ì˜ ë§ì€ ë¦¬ì†ŒìŠ¤ì™€ ì¥ì¹˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆ. ì¦‰, ë§ˆì¹˜ í˜¸ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•œ ê¶Œí•œì„ ë¶€ì—¬ë°›ê²Œ ëœë‹¤.
    
- **ì£¼ìš” ìš©ë„:**
    
    Dockerâ€‘inâ€‘Docker(DinD) í™˜ê²½ì´ë‚˜, ì»¤ë„ ëª¨ë“ˆ ë¡œë”©, ì €ìˆ˜ì¤€ ì‹œìŠ¤í…œ í˜¸ì¶œ ë“±ì´ í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ë•Œ ì‚¬ìš©ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´, GitLab CIì—ì„œ Docker ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ë˜ ë‹¤ë¥¸ Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ privileged ëª¨ë“œê°€ í•„ìš”í•˜ë‹¤.
    

```yaml
# .gitlab-ci.yml
image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"

stages:
  - deploy

deploy:
  stage: deploy
  script:
    - sleep 20  # Docker ë°ëª¬ ì¤€ë¹„ ëŒ€ê¸°
    - docker info  # Docker ì„œë¹„ìŠ¤ í™•ì¸
    - docker-compose -f docker-compose.yml up -d
```

<img src="img/62.png">

ê·¸ë ‡ì§€ë§Œ git runnerì— ì˜¬ë¦° ê±´ ë°”ë¡œ ì‚­ì œê°€ ë˜ì–´ë²„ë¦°ë‹¤. 
runnerëŠ” ì„ì‹œì»¨í…Œì´ë„ˆë¼ì„œ ê·¸ë ‡ë‹¤. ë§Œì•½ ê³„ì† ë°°í¬í•˜ê³  ì‹¶ë‹¤ë©´
ë³„ë„ ì„œë²„ë¥¼ êµ¬ì¶•í•´ì•¼í•  ê²ƒì´ë‹¤. 

### ì˜¤ëŠ˜ì˜ ë„ì „ ê³¼ì œì™€ í•´ê²° ë°©ë²•
- ìƒë‹¨ì— ì‘ì„±í•œ ê²ƒì²˜ëŸ¼ ë‹¤ì–‘í•œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì´ ì¡´ì¬í–ˆë‹¤. ê·¸ ê³¼ì •ì—ì„œ ë¦¬ëˆ…ìŠ¤ ê²½ë¡œ ê°œë…ì´ë‚˜,
ì¸ì¦ì„œ ì‚¬ìš© ê°œë…, git lab runnerì˜ ì‘ë™ë²•ì„ ì•Œ ìˆ˜ ìˆì–´ ì„±ì¥í•  ìˆ˜ ìˆì—ˆë‹¤.

### ì˜¤ëŠ˜ì˜ íšŒê³ 
- ì‚¬ì‹¤ ci/cdë¥¼ ì ìš©í•œ í”„ë¡œì íŠ¸ë¥¼ í•œ ë²ˆë„ ì§„í–‰í•´ë³¸ì  ì—†ê¸° ë•Œë¬¸ì— ì™œ ì‚¬ìš©í•˜ëŠ”ì§€ ì˜ ëª°ëì—ˆë‹¤.
ì´ë²ˆì£¼ ì‹¤ìŠµì„ í•˜ë©° ì¡°ê¸ˆì´ë‚˜ë§ˆ ì´í•´í•  ìˆ˜ ìˆê²Œëœ ê²ƒ ê°™ë‹¤. 

### ì°¸ê³  ìë£Œ ë° ë§í¬
- [gitlab-ci.yml ì‘ì„±](https://velog.io/@duckbill/gitlab-ci.yml-%EC%9E%91%EC%84%B1)
- [gitlab-ci.yml ì‘ì„±](https://velog.io/@minji104/.gitlab-ci.yml-ì‘ì„±)
- [docker host ì™€ container ì—°ê²°í•˜ê¸°!](https://velog.io/@jmyoon8/docker-host-%EC%99%80-container-%EC%97%B0%EA%B2%B0%ED%95%98%EA%B8%B0)